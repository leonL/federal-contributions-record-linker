library("GetoptLong")

normalize_names <- function(full_names){

  # Clean a vector of names and output the clean string, first name, last name, and remaining characters.
  # Cleaning consists of the following steps:
  # 1. convert to all lower case
  # 2. convert accented characters (é) to their alphabetical counterparts (e)
  # 3. drop punctuation marks ("-")
  # 4. replace empty names by 'anon'

  library(dplyr)
  library(magrittr)
  library(stringr)

  ## iterate gsub over a vector of patterns (i.e. set of special characters)
  gsub2 <- function(pattern, replacement, x, ...) {
    for(i in 1:length(pattern))
      x <- gsub(pattern[i], replacement[i], x, ...)
    x
  }

  #coerce a character vector to only contain alphabetical characters
  coerce_to_alpha <- function(names){

    #convert accented characters to their alphabetical counterparts
    from <- c('Š', 'š', 'Ž', 'ž', 'À', 'Á', 'Â', 'Ã', 'Ä', 'Å', 'Æ', 'Ç', 'È', 'É',
              'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ø', 'Ù',
              'Ú', 'Û', 'Ü', 'Ý', 'Þ', 'ß', 'à', 'á', 'â', 'ã', 'ä', 'å', 'æ', 'ç',
              'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ð', 'ñ', 'ò', 'ó', 'ô', 'õ',
              'ö', 'ø', 'ù', 'ú', 'û', 'ý', 'ý', 'þ', 'ÿ')

    to <- c('S', 's', 'Z', 'z', 'A', 'A', 'A', 'A', 'A', 'A', 'A', 'C', 'E', 'E',
            'E', 'E', 'I', 'I', 'I', 'I', 'N', 'O', 'O', 'O', 'O', 'O', 'O', 'U',
            'U', 'U', 'U', 'Y', 'B', 'Ss','a', 'a', 'a', 'a', 'a', 'a', 'a', 'c',
            'e', 'e', 'e', 'e', 'i', 'i', 'i', 'i', 'o', 'n', 'o', 'o', 'o', 'o',
            'o', 'o', 'u', 'u', 'u', 'y', 'y', 'b', 'y')

    normalized <- gsub2(from, to, names)

    # Replace titles and non-alphabetical characters by an empty string and trim
    normalized <- gsub("(^|\\s)((dr|ms|mr|mrs))(\\W|\\s)|(prof(essor)?|miss)\\s", " ", normalized, ignore.case=TRUE)
    normalized <- gsub("(^|\\s)((dr|ms|mr|mrs))(\\W|\\s)|(prof(essor)?|miss)\\s", " ", normalized, ignore.case=TRUE) # repeat title substition to catch secondary titles not preceded by white spaces
    normalized <- gsub("(^|\\s)(and|or)\\s", " ", normalized, ignore.case=TRUE)
    normalized <- gsub("[^a-z| ]", "", normalized, ignore.case=TRUE)
    normalized <- str_trim(normalized)

    return(normalized)
  }

  split_names <- function(x){
    #split full name character vector into last name, first name and remaining characters
    if (length(x)==0) x <- c('anon', 'anon') #if name field is empty, set first_name='anon', last_name='anon'

    n <- length(x)
    first_name <- x[1]
    last_name <- ifelse(n > 1, x[n], "")
    remaining <- paste0(x[-c(1,n)], collapse=' ')

    if (length(remaining)==0) remaining <- ''

    # data.frame(clean_full_name=paste0(x, collapse=" "), clean_first_last_name=paste(first_name, last_name), last_name=last_name, first_name=first_name, remaining=remaining, stringsAsFactors=F)
    data.frame(clean_first_last_name=paste(first_name, last_name), stringsAsFactors=F)
  }

  full_names %>%
    tolower %>%
    coerce_to_alpha %>%
    strsplit(split=' ') %>%
    lapply(FUN=split_names) %>%
    rbind_all
}