source("lib/constants.R")
source("lib/record_linking/normalize_names.R")
source("lib/record_linking/linking.R")

library(GetoptLong)
library(plyr); library(dplyr)

data_store <- commandArgs(TRUE)
data_store_subdir <- switch(data_store[1], mock="0_mock_data", reviewed="as_reviewed_training_set", "as_submitted")

source_dir_name <- paste("cleaned_data/", data_store_subdir, sep="")
target_dir_name <- paste("linked_data/", data_store_subdir, sep="")
data_set <- read.csv(GetoptLong::qq("@{source_dir_name}/@{all_data_csv_file_name}"), encoding="UTF-8")

print("create canonical table of normalized names (first and last only)...")
names_data <- data.frame(full_name=levels(data_set$full_name))
normed_first_last <- normalize_names(names_data$full_name)
names_data <- cbind(names_data, normed_first_last)

print("merge normalized names into main data set...")
data_set <- merge(data_set, names_data)

print("Subsetting unique names by postal code...")
name_and_postal_data <- data_set[,c("clean_first_last_name", "postal_code")]
unique_name_and_postal <- name_and_postal_data[!duplicated(name_and_postal_data),]

print("Match similiar names...")
probable_links <- find_probable_name_matches(unique_name_and_postal)

# sets ids for linked names
print("assigning unique ids to linked names...")
unique_name_and_postal$contributor_id <- NA
side_effect <- dlply(probable_links, .(id1), link_contributors_by_id); rm(side_effect)

print("saving list of link names")
linked_names <- filter(unique_name_and_postal, !is.na(contributor_id))
write.csv(linked_names, file=GetoptLong::qq("@{target_dir_name}/linked_unique_names.csv"), row.names=FALSE)

# set ids for all the unique names that were not matched
print("assigning unique ids to remaning unique names...")
number_without_id <- nrow(unique_name_and_postal[is.na(unique_name_and_postal$contributor_id),])
next_unique_contrib_id <- max(unique_name_and_postal$contributor_id, na.rm=TRUE)
last_unique_contrib_id <- next_unique_contrib_id + number_without_id - 1
unique_name_and_postal$contributor_id[is.na(unique_name_and_postal$contributor_id)] <-
  c(next_unique_contrib_id:last_unique_contrib_id)

# merge the newly defined contrib_ids back into the original data_set
print("Merging contributor_ids into data set...")
data_set <- merge(data_set, unique_name_and_postal)

print("Write CSV file...")
write.csv(data_set, file=GetoptLong::qq("@{target_dir_name}/@{all_data_csv_file_name}"), row.names=FALSE)